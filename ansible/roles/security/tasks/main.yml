---
- name: Configure SSH
  block:
    - name: Update SSH configuration
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
        state: present
      loop:
        - { regexp: '^#?Port', line: 'Port {{ ssh_port }}' }
        - { regexp: '^#?PermitRootLogin', line: 'PermitRootLogin {{ "yes" if ssh_permit_root_login else "no" }}' }
        - { regexp: '^#?PasswordAuthentication', line: 'PasswordAuthentication {{ "yes" if ssh_password_authentication else "no" }}' }
        - { regexp: '^#?PubkeyAuthentication', line: 'PubkeyAuthentication yes' }
      notify: restart sshd

- name: Install and configure UFW
  block:
    - name: Install UFW
      apt:
        name: ufw
        state: present

    - name: Reset UFW
      ufw:
        state: reset

    - name: Configure UFW rules
      ufw:
        rule: "{{ item.rule }}"
        port: "{{ item.port }}"
        proto: "{{ item.proto }}"
        comment: "{{ item.comment | default(omit) }}"
      loop: "{{ ufw_rules }}"

    - name: Enable UFW
      ufw:
        state: enabled
      when: ufw_enabled

- name: Install and configure fail2ban
  block:
    - name: Install fail2ban
      apt:
        name: fail2ban
        state: present

    - name: Configure fail2ban for SSH
      copy:
        dest: /etc/fail2ban/jail.local
        content: |
          [DEFAULT]
          bantime = 3600
          findtime = 600
          maxretry = 5

          [sshd]
          enabled = true
          port = {{ ssh_port }}

    - name: Start fail2ban
      service:
        name: fail2ban
        state: started
        enabled: true

- name: Configure automatic security updates
  apt:
    name: unattended-upgrades
    state: present
