name: Test macOS Setup

on:
  push:
    branches: [main, master]
    paths:
      - 'bootstrap.sh'
      - 'Brewfile'
      - 'scripts/**'
      - 'config/**'
      - '.zshrc'
      - '.github/workflows/test.yml'
  pull_request:
    branches: [main, master]
    paths:
      - 'bootstrap.sh'
      - 'Brewfile'
      - 'scripts/**'
      - 'config/**'
      - '.zshrc'
      - '.github/workflows/test.yml'
  workflow_dispatch:
    inputs:
      debug:
        description: 'Enable debug mode'
        required: false
        default: 'false'

jobs:
  test-macos:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: dotfiles

      - name: Set up dotfiles directory
        run: |
          mkdir -p ~/.dotfiles
          cp -r dotfiles/* ~/.dotfiles/
          cp -r dotfiles/.??* ~/.dotfiles/ 2>/dev/null || true

      - name: Verify Brewfile exists and is valid
        run: |
          cd ~/.dotfiles
          ls -lah Brewfile
          echo ""
          echo "=== Brewfile content (first 30 lines) ==="
          head -30 Brewfile

      - name: Run bootstrap script
        env:
          CI: true
          NONINTERACTIVE: true
        run: |
          cd ~/.dotfiles
          ./bootstrap.sh

      - name: Check brew bundle results
        run: |
          echo "Current PATH: $PATH"
          echo ""
          echo "Homebrew location:"
          which brew
          brew --version
          echo ""
          echo "=== All Installed Formulas ==="
          brew list --formula || echo "No formulas installed"
          echo ""
          echo "=== All Installed Casks ==="
          brew list --cask || echo "No casks installed"
          echo ""
          echo "=== Checking specific packages ==="
          brew list kubernetes-cli 2>/dev/null && echo "✓ kubernetes-cli installed" || echo "✗ kubernetes-cli NOT installed"
          brew list terraform 2>/dev/null && echo "✓ terraform installed" || echo "✗ terraform NOT installed"
          brew list helm 2>/dev/null && echo "✓ helm installed" || echo "✗ helm NOT installed"

      - name: Verify Homebrew installation
        run: |
          brew --version
          echo "Homebrew installed successfully"

      - name: Verify key packages installed
        run: |
          cd ~/.dotfiles
          ./scripts/verify-install.sh

      - name: Verify Oh My Zsh installation
        run: |
          test -d ~/.oh-my-zsh
          echo "Oh My Zsh installed"

      - name: Verify Powerlevel10k installation
        run: |
          test -d ~/.oh-my-zsh/custom/themes/powerlevel10k
          echo "Powerlevel10k installed"

      - name: Verify zsh plugins installed
        run: |
          test -d ~/.oh-my-zsh/custom/plugins/zsh-syntax-highlighting
          test -d ~/.oh-my-zsh/custom/plugins/zsh-autosuggestions
          echo "Zsh plugins installed"

      - name: Verify config files linked
        run: |
          test -L ~/.zshrc || test -f ~/.zshrc
          test -L ~/.gitconfig || test -f ~/.gitconfig
          test -L ~/.vimrc || test -f ~/.vimrc
          test -L ~/.tmux.conf || test -f ~/.tmux.conf
          echo "Config files linked"

      - name: Verify aliases.sh is sourced
        run: |
          zsh -c 'source ~/.zshrc && command -v mkcd'
          zsh -c 'source ~/.zshrc && command -v kln'
          zsh -c 'source ~/.zshrc && command -v gcap'
          echo "Custom aliases loaded"

      - name: Test custom functions
        run: |
          zsh -c 'source ~/.zshrc && type aliases'
          echo "Aliases function works"

      - name: Verify Git configuration
        run: |
          git config --global user.name || echo "Git name not set (expected in CI)"
          git config --global user.email || echo "Git email not set (expected in CI)"
          echo "Git config checked"

      - name: Verify VS Code extensions list exists
        run: |
          test -f ~/.dotfiles/config/vscode/extensions
          echo "VS Code extensions list exists"

      - name: Test kubectl command
        run: |
          eval "$(/opt/homebrew/bin/brew shellenv)" || eval "$(/usr/local/bin/brew shellenv)"
          kubectl version --client
          echo "kubectl works"

      - name: Test OpenTofu command
        run: |
          eval "$(/opt/homebrew/bin/brew shellenv)" || eval "$(/usr/local/bin/brew shellenv)"
          # Clean up any tfenv remnants
          rm -rf ~/.tfenv ~/.config/tfenv 2>/dev/null || true
          tofu version
          echo "OpenTofu works"

      - name: Test helm command
        run: |
          eval "$(/opt/homebrew/bin/brew shellenv)" || eval "$(/usr/local/bin/brew shellenv)"
          helm version
          echo "Helm works"

      - name: Summary
        if: success()
        run: |
          echo "================================"
          echo "All tests passed successfully!"
          echo "================================"
          echo ""
          echo "Verified:"
          echo "  - Homebrew installation"
          echo "  - Core packages (git, kubectl, terraform/tofu, helm, docker, node)"
          echo "  - Oh My Zsh + Powerlevel10k"
          echo "  - Zsh plugins"
          echo "  - Config file linking"
          echo "  - Custom aliases and functions"
          echo "  - Tool versions"
          echo ""
          echo "Dotfiles setup is working correctly!"
