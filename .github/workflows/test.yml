name: Test Dotfiles Setup

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  test-macos:
    runs-on: macos-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: dotfiles

      - name: Set up dotfiles directory
        run: |
          mkdir -p ~/.dotfiles
          cp -r dotfiles/* ~/.dotfiles/
          cp -r dotfiles/.??* ~/.dotfiles/ 2>/dev/null || true

      - name: Verify Brewfile exists and is valid
        run: |
          cd ~/.dotfiles
          ls -lah Brewfile
          echo ""
          echo "=== Brewfile content (first 30 lines) ==="
          head -30 Brewfile
          
      - name: Run bootstrap script
        env:
          CI: true
          NONINTERACTIVE: true
        run: |
          cd ~/.dotfiles
          ./bootstrap.sh
          
      - name: Check brew bundle results
        run: |
          echo "Current PATH: $PATH"
          echo ""
          echo "Homebrew location:"
          which brew
          brew --version
          echo ""
          echo "=== All Installed Formulas ==="
          brew list --formula || echo "No formulas installed"
          echo ""
          echo "=== All Installed Casks ==="
          brew list --cask || echo "No casks installed"
          echo ""
          echo "=== Checking specific packages ==="
          brew list kubernetes-cli 2>/dev/null && echo "✓ kubernetes-cli installed" || echo "✗ kubernetes-cli NOT installed"
          brew list terraform 2>/dev/null && echo "✓ terraform installed" || echo "✗ terraform NOT installed"
          brew list helm 2>/dev/null && echo "✓ helm installed" || echo "✗ helm NOT installed"

      - name: Verify Homebrew installation
        run: |
          brew --version
          echo "Homebrew installed successfully"

      - name: Verify key packages installed
        run: |
          # Ensure Homebrew is in PATH
          eval "$(/opt/homebrew/bin/brew shellenv)" || eval "$(/usr/local/bin/brew shellenv)"
          
          echo "Checking installed packages..."
          FAILED=0
          
          # Check each package individually
          if command -v git &> /dev/null; then
            echo "✓ git: $(which git)"
          else
            echo "✗ git: NOT FOUND"
            FAILED=1
          fi
          
          if command -v kubectl &> /dev/null; then
            echo "✓ kubectl: $(which kubectl)"
          else
            echo "✗ kubectl: NOT FOUND"
            FAILED=1
          fi
          
          if command -v terraform &> /dev/null; then
            echo "✓ terraform: $(which terraform)"
          else
            echo "✗ terraform: NOT FOUND"
            FAILED=1
          fi
          
          if command -v helm &> /dev/null; then
            echo "✓ helm: $(which helm)"
          else
            echo "✗ helm: NOT FOUND"
            FAILED=1
          fi
          
          if command -v node &> /dev/null; then
            echo "✓ node: $(which node)"
          else
            echo "✗ node: NOT FOUND"
            FAILED=1
          fi
          
          if command -v python3 &> /dev/null; then
            echo "✓ python3: $(which python3)"
          else
            echo "✗ python3: NOT FOUND"
            FAILED=1
          fi
          
          # Docker is optional (not available on macOS runners by default)
          if command -v docker &> /dev/null; then
            echo "✓ docker: $(which docker)"
          else
            echo "⚠ docker: NOT FOUND (optional, skipping)"
          fi
          
          if [ $FAILED -eq 1 ]; then
            echo ""
            echo "Some packages failed to install!"
            exit 1
          fi
          
          echo ""
          echo "All core packages verified!"

      - name: Verify Oh My Zsh installation
        run: |
          test -d ~/.oh-my-zsh
          echo "Oh My Zsh installed"

      - name: Verify Powerlevel10k installation
        run: |
          test -d ~/.oh-my-zsh/custom/themes/powerlevel10k
          echo "Powerlevel10k installed"

      - name: Verify zsh plugins installed
        run: |
          test -d ~/.oh-my-zsh/custom/plugins/zsh-syntax-highlighting
          test -d ~/.oh-my-zsh/custom/plugins/zsh-autosuggestions
          echo "Zsh plugins installed"

      - name: Verify config files linked
        run: |
          test -L ~/.zshrc || test -f ~/.zshrc
          test -L ~/.gitconfig || test -f ~/.gitconfig
          test -L ~/.vimrc || test -f ~/.vimrc
          test -L ~/.tmux.conf || test -f ~/.tmux.conf
          echo "Config files linked"

      - name: Verify aliases.sh is sourced
        run: |
          zsh -c 'source ~/.zshrc && command -v mkcd'
          zsh -c 'source ~/.zshrc && command -v kln'
          zsh -c 'source ~/.zshrc && command -v gcap'
          echo "Custom aliases loaded"

      - name: Test custom functions
        run: |
          zsh -c 'source ~/.zshrc && type aliases'
          echo "Aliases function works"

      - name: Verify Git configuration
        run: |
          git config --global user.name || echo "Git name not set (expected in CI)"
          git config --global user.email || echo "Git email not set (expected in CI)"
          echo "Git config checked"

      - name: Verify VS Code extensions list exists
        run: |
          test -f ~/.dotfiles/config/vscode/extensions
          echo "VS Code extensions list exists"

      - name: Test kubectl command
        run: |
          eval "$(/opt/homebrew/bin/brew shellenv)" || eval "$(/usr/local/bin/brew shellenv)"
          kubectl version --client
          echo "kubectl works"

      - name: Test terraform command
        run: |
          eval "$(/opt/homebrew/bin/brew shellenv)" || eval "$(/usr/local/bin/brew shellenv)"
          terraform version
          echo "Terraform works"

      - name: Test helm command
        run: |
          eval "$(/opt/homebrew/bin/brew shellenv)" || eval "$(/usr/local/bin/brew shellenv)"
          helm version
          echo "Helm works"

      - name: Summary
        if: success()
        run: |
          echo "================================"
          echo "All tests passed successfully!"
          echo "================================"
          echo ""
          echo "Verified:"
          echo "  - Homebrew installation"
          echo "  - Core packages (git, kubectl, terraform, helm, docker, node)"
          echo "  - Oh My Zsh + Powerlevel10k"
          echo "  - Zsh plugins"
          echo "  - Config file linking"
          echo "  - Custom aliases and functions"
          echo "  - Tool versions"
          echo ""
          echo "Dotfiles setup is working correctly!"
