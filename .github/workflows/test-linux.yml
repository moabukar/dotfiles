name: Test Linux Setup

on:
  push:
    branches: [main, master]
    paths:
      - 'linux/**'
      - 'config/vim/**'
      - 'config/tmux/**'
      - 'config/git/**'
      - '.zshrc'
      - 'scripts/link.sh'
      - 'scripts/util.sh'
      - '.github/workflows/test-linux.yml'
  pull_request:
    branches: [main, master]
    paths:
      - 'linux/**'
      - 'config/vim/**'
      - 'config/tmux/**'
      - 'config/git/**'
      - '.zshrc'
      - 'scripts/link.sh'
      - 'scripts/util.sh'
      - '.github/workflows/test-linux.yml'
  workflow_dispatch:
    inputs:
      debug:
        description: 'Enable debug mode'
        required: false
        default: 'false'

jobs:
  test-ubuntu:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: dotfiles

      - name: Set up dotfiles directory
        run: |
          mkdir -p ~/.dotfiles
          cp -r dotfiles/* ~/.dotfiles/
          cp -r dotfiles/.??* ~/.dotfiles/ 2>/dev/null || true

      - name: Display system info
        run: |
          echo "=== System Information ==="
          uname -a
          cat /etc/os-release
          echo ""
          echo "=== Available Resources ==="
          df -h
          free -h

      - name: Run bootstrap script
        env:
          CI: true
          NONINTERACTIVE: true
        run: |
          cd ~/.dotfiles/linux
          chmod +x bootstrap.sh
          ./bootstrap.sh

      - name: Verify essential packages
        run: |
          echo "=== Verifying Essential Packages ==="
          FAILED=0

          if command -v zsh &> /dev/null; then
            echo "✓ zsh: $(which zsh)"
          else
            echo "✗ zsh: NOT FOUND"
            FAILED=1
          fi

          if command -v git &> /dev/null; then
            echo "✓ git: $(which git)"
          else
            echo "✗ git: NOT FOUND"
            FAILED=1
          fi

          if command -v vim &> /dev/null; then
            echo "✓ vim: $(which vim)"
          else
            echo "✗ vim: NOT FOUND"
            FAILED=1
          fi

          if command -v tmux &> /dev/null; then
            echo "✓ tmux: $(which tmux)"
          else
            echo "✗ tmux: NOT FOUND"
            FAILED=1
          fi

          if [ $FAILED -eq 1 ]; then
            echo ""
            echo "Some essential packages failed to install!"
            exit 1
          fi

          echo ""
          echo "All essential packages verified!"

      - name: Verify Oh My Zsh installation
        run: |
          test -d ~/.oh-my-zsh
          echo "Oh My Zsh installed"

      - name: Verify Powerlevel10k installation
        run: |
          test -d ~/.oh-my-zsh/custom/themes/powerlevel10k
          echo "Powerlevel10k installed"

      - name: Verify zsh plugins installed
        run: |
          test -d ~/.oh-my-zsh/custom/plugins/zsh-syntax-highlighting
          test -d ~/.oh-my-zsh/custom/plugins/zsh-autosuggestions
          echo "Zsh plugins installed"

      - name: Verify config files linked
        run: |
          test -L ~/.zshrc || test -f ~/.zshrc
          test -f ~/.dotfiles/config/vim/.vimrc
          test -f ~/.dotfiles/config/tmux/.tmux.conf
          echo "Config files present"

      - name: Verify Docker installation
        run: |
          if command -v docker &> /dev/null; then
            echo "✓ Docker installed: $(docker --version)"
          else
            echo "✗ Docker: NOT FOUND"
            exit 1
          fi

      - name: Verify Docker Compose installation
        run: |
          if command -v docker-compose &> /dev/null; then
            echo "✓ Docker Compose installed: $(docker-compose --version)"
          else
            echo "✗ Docker Compose: NOT FOUND"
            exit 1
          fi

      - name: Test kubectl command
        run: |
          if command -v kubectl &> /dev/null; then
            kubectl version --client
            echo "kubectl works"
          else
            echo "✗ kubectl: NOT FOUND"
            exit 1
          fi

      - name: Test helm command
        run: |
          if command -v helm &> /dev/null; then
            helm version
            echo "helm works"
          else
            echo "✗ helm: NOT FOUND"
            exit 1
          fi

      - name: Test k9s command
        run: |
          if command -v k9s &> /dev/null; then
            k9s version
            echo "k9s works"
          else
            echo "✗ k9s: NOT FOUND"
            exit 1
          fi

      - name: Test OpenTofu command
        run: |
          if command -v tofu &> /dev/null; then
            tofu version
            echo "OpenTofu works"
          else
            echo "✗ tofu: NOT FOUND"
            exit 1
          fi

      - name: Test AWS CLI
        run: |
          if command -v aws &> /dev/null; then
            aws --version
            echo "AWS CLI works"
          else
            echo "✗ aws: NOT FOUND"
            exit 1
          fi

      - name: Test Azure CLI
        run: |
          if command -v az &> /dev/null; then
            az version
            echo "Azure CLI works"
          else
            echo "✗ az: NOT FOUND"
            exit 1
          fi

      - name: Test GitHub CLI
        run: |
          if command -v gh &> /dev/null; then
            gh --version
            echo "GitHub CLI works"
          else
            echo "✗ gh: NOT FOUND"
            exit 1
          fi

      - name: Test better CLI tools
        run: |
          echo "=== Testing Better CLI Tools ==="

          # Test bat
          if command -v bat &> /dev/null; then
            echo "✓ bat installed"
          else
            echo "⚠ bat: NOT FOUND"
          fi

          # Test eza
          if command -v eza &> /dev/null; then
            echo "✓ eza installed"
          else
            echo "⚠ eza: NOT FOUND"
          fi

          # Test fzf
          if command -v fzf &> /dev/null; then
            echo "✓ fzf installed"
          else
            echo "⚠ fzf: NOT FOUND"
          fi

          # Test ripgrep
          if command -v rg &> /dev/null; then
            echo "✓ ripgrep installed"
          else
            echo "⚠ ripgrep: NOT FOUND"
          fi

          # Test fd
          if command -v fd &> /dev/null; then
            echo "✓ fd installed"
          else
            echo "⚠ fd: NOT FOUND"
          fi

          # Test delta
          if command -v delta &> /dev/null; then
            echo "✓ delta installed"
          else
            echo "⚠ delta: NOT FOUND"
          fi

          echo "Better CLI tools check complete"

      - name: Test custom functions
        run: |
          zsh -c 'source ~/.zshrc && type aliases' || echo "⚠ aliases function not available in CI"
          echo "Shell functions test complete"

      - name: Display installed versions
        run: |
          echo "=== Installed Tool Versions ==="
          echo "Docker: $(docker --version)"
          echo "kubectl: $(kubectl version --client --short 2>/dev/null || echo 'N/A')"
          echo "Helm: $(helm version --short 2>/dev/null || echo 'N/A')"
          echo "OpenTofu: $(tofu version 2>/dev/null | head -1 || echo 'N/A')"
          echo "AWS CLI: $(aws --version 2>&1 || echo 'N/A')"
          echo "GitHub CLI: $(gh --version | head -1 || echo 'N/A')"
          echo "Node: $(node --version 2>/dev/null || echo 'N/A')"
          echo "Go: $(go version 2>/dev/null || echo 'N/A')"
          echo "Rust: $(rustc --version 2>/dev/null || echo 'N/A')"

      - name: Verify Docker service (optional)
        continue-on-error: true
        run: |
          sudo systemctl start docker || true
          docker ps || echo "Docker daemon not available in CI"

      - name: Final summary
        run: |
          echo "================================"
          echo "✅ Linux setup test completed successfully!"
          echo "================================"
          echo ""
          echo "All critical tools installed and verified:"
          echo "  - Shell: Zsh + Oh My Zsh + Powerlevel10k"
          echo "  - Containers: Docker + Docker Compose"
          echo "  - Kubernetes: kubectl, helm, k9s"
          echo "  - IaC: OpenTofu"
          echo "  - Cloud: AWS CLI, Azure CLI"
          echo "  - DevOps: GitHub CLI, better CLI tools"
